<head>
    <title>INFO-MAP - Take care of your info of mess!</title>
    <%= stylesheet_link_tag "application", media: "all" %>
    <%= javascript_include_tag "application" %>
        <%= javascript_include_tag "defaults" %>
        <%= javascript_include_tag "prototype" %>
    <%= csrf_meta_tags %>
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
</head>
  
  <body onload="init();">
  
  <script type="text/javascript" language="javascript">
  
  function drawLink(ctx, f, t)
  {
  	  var fx = f.offsetLeft, fy = f.offsetTop, fl = f.offsetWidth;
  	  var tx = t.offsetLeft, ty = t.offsetTop;
  	  
  	  while(f=f.offsetParent) {
  	  	  fx += f.offsetLeft;
  	  	  fy += f.offsetTop;
  	  }
  	  while(t=t.offsetParent) {
  	  	  tx += t.offsetLeft;
  	  	  ty += t.offsetTop;
  	  }
  	  
  	  //alert("fx:" + fx +",fy:" + fy + ",tx:" + tx + ",ty:" + ty)
  	  ctx.moveTo(fx + fl - 15, fy)
  	  ctx.lineTo(tx,ty + 15 )
  	  ctx.stroke()
  	  ctx.closePath()
  }
  
  function init() {
  	  var canvas = document.getElementById('canvas');
  	  var contex = canvas.getContext('2d');
  	  contex.strokeStyle = "pink"
  	  
  	  var linfo = document.getElementById('linfo');
  	  var cinfo = document.getElementById('cinfo');
  	  var cinfos = document.getElementsByName('cinfos');
  	  var rinfos = document.getElementsByName('rinfos');
  	  
  	  if (linfo && cinfo) {
  	  	  //alert(111);
  	  	  for ( var i = 0; i < cinfos.length; i++) {
  	  	  	  //alert("cinfos:" + cinfos[i].id);
  	  	  	  drawLink(contex, linfo, cinfos[i]);
  	  	  }
  	  	  for (var i = 0; i < rinfos.length; i++) {
  	  	  	  //alert("rinfos:"+i);
  	  	  	  drawLink(contex, cinfo, rinfos[i]);
  	  	  }
  	  }
  }
  
  function   getAbsPoint(e)      
 {      /*
    var   x   =   e.offsetLeft,   y   =   e.offsetTop;      
    while(e=e.offsetParent)    
    {    
       x   +=   e.offsetLeft;      
       y   +=   e.offsetTop;   
    }    
    alert("x:"+x+","+"y:"+y);      */
 }
  
  function switchpoolstatus() {
	$.get("/application/switchpoolstatus",function(){
		// alert("Switched Pool Status");
	});
  }
  
  linkId = 0
  fromId = 0
  toId = 0
  indexFromId = 0
  
  function moveFrom(linkid, infoid) {
	// move info to new place, break original link
	linkId = linkid;
	toId = infoid;
	fromId = 0;
  }
  function moveIndexFrom(linkid) {
	indexFromId = linkid;
  }
  function refFrom(id) {
	// reference new info, add new link
	fromId = id;
	toId = 0;
  }
  function endTo(id, tolinkid) {
	//alert("endTo(" + id + "," + tolinkid + ")") ;
	if (fromId == id || (indexFromId == tolinkid && indexFromId != 0)) {
		alert("useless");
		linkId = 0
		fromId = 0
		toId = 0
		indexFromId = 0
		return
	}
	if ( indexFromId > 0) {
		// this is switch operation
		//alert("switch from "+ indexFromId + "to" + tolinkid );
		window.location.href="/infolink/switchlink?indexfromid=" + indexFromId + "&indextoid=" + tolinkid;
	}
	else if (fromId == 0 && tolinkid != 0) {
		// this is a move operation
		//alert("move from "+ toId + "to" + id + ", break link:" + linkId );
		if(toId == 0 || id == 0) {
			linkId = 0
			fromId = 0
			toId = 0
			indexFromId = 0
			return
		}
		window.location.href="/infolink/movelink?frominfoid=" + id + "&toinfoid=" + toId + "&breaklinkid=" + linkId;
	} else if (toId == 0) {
		//this is a reference operation
		//alert("reference from " + fromId + " to" + id);
		window.location.href="/infolink/buildlink?frominfoid=" + fromId + "&toinfoid=" + id;
	} else if (tolinkid == 0) {
		//this is a new connection creation
		//alert("Create link from " +  id + " to" + toId);
		window.location.href="/infolink/buildlink?frominfoid=" + id + "&toinfoid=" + toId;
	}
	linkId = 0
	fromId = 0
	toId = 0
	indexFromId = 0
  }

  
  function choseInfo(cid, pid) {
	window.location.href="/application/setcurrent?selectpiece=" + cid + "&parentpiece=" + pid;
  }
  
  function expandInfo(infoid) {
	window.location.href="/application/switchexpansion?infoid=" + infoid;
  }
/*  
  function drawarrow() {
	var canvas = document.getElementById('canvas');
	var ctx=canvas.getContext("2d");

	ctx.strokeStyle = "rgba(0,0,0,0.5)";
	ctx.fillStyle = "#FF0000";
	ctx.lineWidth = 6;
	ctx.beginPath();
	ctx.moveTo(200,100);
    ctx.lineTo(100,200);
    ctx.lineTo(300,200);
    ctx.closePath();
    ctx.stroke();
  }
 */
  
  </script>
 <canvas id="canvas" class="navbar-fixed-top" style="position:absolute;z-index:-1" width="1600" height="1200" ></canvas> 
    <header class="navbar navbar-fixed-top navbar-inverse">
      <div class="navbar-inner">
        <div class="container-fluid">
          <%= link_to "INFO-MAP", '#', id: "logo" %>
			
            <ul class="nav pull-right">
                         <% if current_user %>
                                <li><%= link_to current_user.email, user_path(current_user), :onclick=>"window.open(this.href,'create_company', 'height=650, width=800');return false;" %></li>

                                <li><%= link_to('LogOut', destroy_user_session_path, :method => :delete) %></li>
                                <li><%= link_to('ChangePwd', edit_registration_path(:user)) %></li>
                         <% else %>
                                <li><%= link_to('Register', new_registration_path(:user)) %></li>
                                <li><%= link_to('Login', new_session_path(:user)) %> </li>
                         <% end %>
            </ul>
          </nav>
        </div>
      </div>
    </header>
	<% if current_user then %>
		<div><%= render "pool" %></div>
<!--		
			<div class="span" data-spy="affix" style="overflow:auto; height: 500px; width: 100%"> 
-->
			<div class="span4">
			<%= render "application/roottree" %>
		</div>
	<% end %>
    <div class="container toright">
		
<!--------------------

		session expandinfo:<%= session[:expandinfo] %><br>
		session test:<%= session[:test] %><br>
		session cpiece:<%= session[:cpiece] %><br>
		session lpiece:<%= session[:lpiece] %><br>
		@current_cinfo:<%= @current_cinfo.id if @current_cinfo != nil %><br>
		@current_linfo:<%= @current_linfo.id if @current_linfo != nil %><br>
----------------------->
	
      <%= yield %>
    </div>
  </body>

</html>